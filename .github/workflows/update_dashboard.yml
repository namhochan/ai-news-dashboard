name: Update AI News Dashboard (hourly)

on:
  schedule:
    - cron: "0 * * * *"   # 매시 정각
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Update data files
        env:
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}   # 선택(없어도 작동)
        run: |
          python scripts/update_dashboard.py

      - name: Commit & push data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/*.json
          if git commit -m "auto: hourly refresh"; then
            git push
          else
            echo "No changes to commit."
          fi

      - name: Build Telegram message
        id: msg
        run: |
          python scripts/update_dashboard.py --summary-only > msg.txt
          echo "text<<EOF" >> $GITHUB_OUTPUT
          cat msg.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Telegram Alert
        if: ${{ secrets.TELEGRAM_BOT_TOKEN != '' && secrets.TELEGRAM_CHAT_ID != '' }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT:  ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          set -e
          # 줄바꿈/특수문자 처리 위해 JSON 전송
          curl -sS -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\":\"${TG_CHAT}\",\"text\":\"${{ steps.msg.outputs.text }}\",\"parse_mode\":\"Markdown\"}"
